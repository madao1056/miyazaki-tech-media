---
import BaseLayout from "@/layouts/base.astro";
import { getEntry } from "astro:content";
import { articlesHandler } from "@/lib/handlers/articles";
import RankingMainCard from "@/components/cards/rankingMainCard.astro";
import RankingSubCard from "@/components/cards/rankingSubCard.astro";
import LatestArticles from "@/components/sidebar/latest-articles.astro";
import AdSpace from "@/components/sidebar/ad-space.astro";
import CategorySearch from "@/components/sidebar/category-search.astro";
import PopularArticles from "@/components/sidebar/popular-articles.astro";

const entry = await getEntry("views", "ranking");

if (!entry) {
  return Astro.redirect("/404");
}

// 実際の記事データから人気ランキングを取得
const topArticles = await articlesHandler.getTopArticles();

// 日付フォーマット用のヘルパー関数
const formatDateRange = () => {
  const endDate = new Date();
  const startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000);
  return {
    start: startDate.toLocaleDateString('ja-JP'),
    end: endDate.toLocaleDateString('ja-JP')
  };
};

const dateRange = formatDateRange();
---

<BaseLayout entry={entry}>
  <div class="bg-base-200 min-h-screen">
    <div class="container max-w-7xl mx-auto px-4 pt-4 pb-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
        <!-- メインコンテンツ -->
        <div class="lg:col-span-2 order-1">
          <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
            <main>
    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
        週間ランキング
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto mb-6">
        今週最も読まれた記事をランキング形式でお届け
      </p>
      <div class="text-sm text-gray-500">
        集計期間: {dateRange.start} - {dateRange.end}
      </div>
    </header>

    <!-- ランキング算出方法の説明 -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-8">
      <h2 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-2">
        ランキング算出方法
      </h2>
      <p class="text-blue-800 dark:text-blue-200 text-sm">
        新しい記事と掲載順序を基に人気度スコアを自動算出しています
      </p>
    </div>

    <!-- メインランキング表示 -->
    <div class="grid lg:grid-cols-2 gap-8 mb-12">
      <!-- 1位記事（左側） -->
      <div>
        {topArticles[0] && (
          <RankingMainCard article={topArticles[0]} rank={1} />
        )}
      </div>
      
      <!-- 2-3位記事（右側・縦並び） -->
      <div class="space-y-6">
        {topArticles[1] && (
          <RankingMainCard article={topArticles[1]} rank={2} />
        )}
        {topArticles[2] && (
          <RankingMainCard article={topArticles[2]} rank={3} />
        )}
      </div>
    </div>

    <!-- 4位以下一覧 -->
    {topArticles.length > 3 && (
      <div class="space-y-4">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 border-b border-gray-200 dark:border-gray-700 pb-2">
          その他のランキング
        </h2>
        <div class="space-y-0 divide-y divide-gray-200 dark:divide-gray-700">
          {topArticles.slice(3).map((article, index) => {
            const rank = index + 4;
            const isLast = index === topArticles.slice(3).length - 1;
            return (
              <RankingSubCard 
                article={article} 
                rank={rank} 
                isLast={isLast} 
              />
            );
          })}
        </div>
      </div>
    )}
    
    <!-- 過去のランキング -->
    <div class="text-center mt-12">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
        過去のランキング
      </h2>
      <div class="grid md:grid-cols-3 gap-4">
        <a href="/ranking/2024-01-01" class="block bg-gray-50 dark:bg-gray-800 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <div class="font-semibold">先週のランキング</div>
          <div class="text-sm text-gray-500">2024/1/1 - 2024/1/7</div>
        </a>
        <a href="/ranking/2023-12-25" class="block bg-gray-50 dark:bg-gray-800 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <div class="font-semibold">先々週のランキング</div>
          <div class="text-sm text-gray-500">2023/12/25 - 2023/12/31</div>
        </a>
        <a href="/ranking/archive" class="block bg-gray-50 dark:bg-gray-800 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <div class="font-semibold">アーカイブ</div>
          <div class="text-sm text-gray-500">過去の全ランキング</div>
        </a>
      </div>
    </div>
            </main>
          </div>
        </div>
        
        <!-- サイドバー -->
        <aside class="lg:col-span-1 order-2">
          <div class="space-y-6">
            <LatestArticles />
            <AdSpace />
            <CategorySearch />
            <PopularArticles />
          </div>
        </aside>
      </div>
    </div>
  </div>
</BaseLayout>