---
import { categoriesHandler } from "@/lib/handlers/categories";

const categories = categoriesHandler.allCategories();

// タグリスト（よく使われるタグ）
const popularTags = [
  "フリーランス",
  "起業",
  "副業",
  "リモートワーク",
  "宮崎市",
  "Web制作",
  "地方移住",
  "30代独立",
  "小さな会社",
  "地域密着",
];
---

<div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
  <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    記事を検索
  </h3>
  
  <form class="flex flex-col gap-4">
    <!-- カテゴリー選択 -->
    <div>
      <label for="category" class="text-sm font-medium mb-2 block">カテゴリー</label>
      <select
        id="category"
        class="w-full px-3 py-2 bg-base-100 border border-base-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
      >
        <option value="">すべてのカテゴリー</option>
        {categories.map((category) => (
          <option value={category.id}>{category.data.title}</option>
        ))}
      </select>
    </div>

    <!-- タグ選択 -->
    <div>
      <label class="text-sm font-medium mb-2 block">タグ</label>
      <div class="max-h-48 overflow-y-auto">
        <div class="flex flex-wrap gap-2">
          {popularTags.map((tag) => (
            <label class="inline-flex items-center gap-1 cursor-pointer hover:bg-base-300 px-3 py-1.5 rounded-full transition-colors border border-base-300 bg-base-100">
              <input
                type="checkbox"
                name="tags"
                value={tag}
                class="checkbox checkbox-xs checkbox-primary"
              />
              <span class="text-xs whitespace-nowrap">{tag}</span>
            </label>
          ))}
        </div>
      </div>
    </div>

    <!-- 検索ボタン -->
    <button
      type="button"
      id="search-btn"
      class="w-full btn btn-primary"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      検索
    </button>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchBtn = document.getElementById('search-btn');
    const categorySelect = document.getElementById('category') as HTMLSelectElement;
    
    searchBtn?.addEventListener('click', () => {
      const selectedCategory = categorySelect?.value;
      const tagCheckboxes = document.querySelectorAll('input[name="tags"]:checked') as NodeListOf<HTMLInputElement>;
      const selectedTags = Array.from(tagCheckboxes).map(cb => cb.value);
      
      // タグが選択されている場合は検索ページへ
      if (selectedTags.length > 0) {
        const params = new URLSearchParams();
        if (selectedCategory) {
          params.append('category', selectedCategory);
        }
        selectedTags.forEach(tag => params.append('tags', tag));
        window.location.href = `/search-tags?${params.toString()}`;
      } 
      // タグが選択されていない場合はカテゴリーページへ
      else if (selectedCategory) {
        window.location.href = `/categories/${selectedCategory}`;
      } 
      // 何も選択されていない場合は全記事へ
      else {
        window.location.href = '/articles';
      }
    });
  });
</script>