# Requirements Document: OAuth認証追加

## Project Description (Input)

既存認証にOAuthを追加

## 1. 機能概要

BizMapの完全静的サイト構成を維持しながら、外部OAuthプロバイダーを使用した認証機能を追加します。記事へのコメント、ブックマーク、お気に入り著者フォローなどのユーザー機能を将来的に実装するための認証基盤を構築します。

## 2. 背景と目的

### 現状

- BizMapは完全静的サイト（Astro SSG）で構築
- 現在は認証機能が存在しない
- ユーザーインタラクション機能（コメント、ブックマーク等）が未実装

### 目的

1. ユーザーがソーシャルアカウントで簡単にログイン可能に
2. 静的サイトのパフォーマンス優位性を維持
3. 将来的なユーザー機能拡張の基盤構築
4. セキュアで保守性の高い認証システム

## 3. 機能要件

### 3.1 対応OAuthプロバイダー

- **Google OAuth 2.0** (必須)
- **GitHub OAuth** (必須)
- **Twitter/X OAuth 2.0** (オプション、将来対応)

### 3.2 認証フロー

1. **ログインボタン**: ヘッダー・サイドバーに配置
2. **プロバイダー選択**: モーダルまたはポップアップで選択画面表示
3. **OAuth認証**: 外部プロバイダーの認証画面へリダイレクト
4. **コールバック処理**: 認証成功後のトークン処理
5. **セッション管理**: ログイン状態の維持
6. **ログアウト**: セッション無効化

### 3.3 ユーザー情報管理

取得する情報：

- ユーザーID（プロバイダー固有）
- 表示名
- メールアドレス（取得可能な場合）
- プロフィール画像URL

### 3.4 UI/UX要件

- **ログイン前**:
  - 「ログイン」ボタンをヘッダー右上に表示
  - クリックでOAuthプロバイダー選択モーダル表示
- **ログイン後**:
  - ユーザーアバター画像をヘッダー右上に表示
  - クリックでドロップダウンメニュー
    - マイページ（将来実装）
    - ログアウト

- **デザイン統合**:
  - Tailwind CSS + DaisyUIのテーマシステムに準拠
  - ダークモード対応
  - レスポンシブデザイン

### 3.5 セキュリティ要件

- **トークン管理**:
  - アクセストークンはHTTPOnly Cookieで保存
  - リフレッシュトークンの安全な管理
  - CSRF対策（state parameter使用）
- **通信セキュリティ**:
  - HTTPS必須
  - CORS設定の適切な制限
- **セッション管理**:
  - セッションタイムアウト設定（例: 7日間）
  - 自動ログアウト機能

### 3.6 バックエンド要件

静的サイトのため、以下のいずれかのアプローチを採用：

#### オプションA: Astro Server Endpoints

- Astro SSRモード部分採用
- `/api/auth/*` エンドポイントのみSSR化
- Vercel Serverless Functions利用

#### オプションB: 外部認証サービス

- Auth0、Supabase Auth、Firebase Authentication等
- 既存の静的サイト構成を完全維持

**推奨**: オプションB（外部サービス利用）
理由: 静的サイトのメリット維持、運用コスト削減、セキュリティ対策の標準化

## 4. 非機能要件

### 4.1 パフォーマンス

- 認証UIの追加がページロード速度に影響しない
- Lighthouse スコア 95+ を維持
- 初回表示時は認証チェック非同期実行

### 4.2 可用性

- 認証サービス障害時も、サイト閲覧は正常動作
- 認証が必要な機能のみ制限表示

### 4.3 スケーラビリティ

- 将来的なユーザー数増加に対応可能
- プロバイダー追加が容易な設計

### 4.4 保守性

- 認証ロジックは `/src/lib/auth/` に集約
- TypeScript型定義を完備
- 環境変数での設定管理

### 4.5 互換性

- モダンブラウザ対応（Chrome、Firefox、Safari、Edge 最新2バージョン）
- モバイルブラウザ対応

## 5. 技術的制約

### 5.1 既存アーキテクチャとの整合性

- Astro v5 + React v19 構成を維持
- Tailwind CSS + DaisyUI スタイリングに準拠
- TypeScript strict mode 対応

### 5.2 デプロイメント環境

- Vercel デプロイ環境
- 環境変数での設定管理
  - `OAUTH_CLIENT_ID_GOOGLE`
  - `OAUTH_CLIENT_SECRET_GOOGLE`
  - `OAUTH_CLIENT_ID_GITHUB`
  - `OAUTH_CLIENT_SECRET_GITHUB`
  - `JWT_SECRET` または `SESSION_SECRET`

### 5.3 コスト制約

- Vercel無料枠内での運用を優先
- 外部サービス使用時は無料プラン範囲内

## 6. データモデル

### 6.1 ユーザー情報

```typescript
interface User {
  id: string; // システム内部ID
  provider: "google" | "github"; // OAuthプロバイダー
  providerId: string; // プロバイダー固有ID
  displayName: string;
  email?: string;
  avatarUrl?: string;
  createdAt: Date;
  lastLoginAt: Date;
}
```

### 6.2 セッション情報

```typescript
interface Session {
  userId: string;
  accessToken: string;
  refreshToken?: string;
  expiresAt: Date;
}
```

## 7. 成功基準

### 7.1 機能的成功基準

- [ ] Google OAuthでログイン・ログアウトが正常動作
- [ ] GitHub OAuthでログイン・ログアウトが正常動作
- [ ] ログイン状態がページ遷移後も維持される
- [ ] ユーザー情報（名前、アバター）が正しく表示される
- [ ] ログアウト後はログイン前の状態に戻る

### 7.2 技術的成功基準

- [ ] Lighthouse Performance スコア 95+ 維持
- [ ] TypeScript型エラー0件
- [ ] セキュリティベストプラクティス準拠
- [ ] CSRF攻撃に対する保護が実装されている

### 7.3 UX成功基準

- [ ] ログインボタンから3クリック以内でログイン完了
- [ ] モバイルでも快適に操作可能
- [ ] ダークモードで適切に表示される
- [ ] エラーメッセージが分かりやすい

## 8. 実装範囲外（将来実装）

以下は今回の実装範囲外とし、認証基盤構築後に段階的に実装：

- ユーザープロフィールページ
- 記事へのコメント機能
- 記事のブックマーク機能
- 著者フォロー機能
- 通知機能

## 9. 想定されるリスクと対策

### リスク1: 静的サイトとOAuthの技術的整合性

**対策**: 外部認証サービス（Supabase Auth推奨）を利用し、クライアントサイドSDKで実装

### リスク2: セキュリティ脆弱性

**対策**: 実績のある外部サービス利用、定期的なセキュリティ監査

### リスク3: パフォーマンス劣化

**対策**: 認証チェックは非同期実行、認証UI遅延ロード

### リスク4: コスト超過

**対策**: 無料プラン範囲内での設計、使用量モニタリング

## 10. 次ステップ

要件承認後、以下のフェーズに進みます：

1. **設計フェーズ**: 技術選定、アーキテクチャ設計
2. **タスク分解フェーズ**: 実装タスクの詳細化
3. **実装フェーズ**: コーディング・テスト

---

**承認が必要**: この要件定義を確認し、承認してください。
修正が必要な場合は、具体的な変更点を指摘してください。
